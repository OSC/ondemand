<h2>files index page</h2>

<div class="text-right">
  <button type="button" class="btn btn-default btn-sm"><i class="fas fa-folder" aria-hidden="true"></i> Go To...</button>

  <%# FIXME: open in terminal should be dropdown of all clusters (with default) %>
  <button type="button" class="btn btn-default btn-sm"><i class="fas fa-terminal" aria-hidden="true"></i> Open in Terminal</button>
  <button id="new-file-btn" type="button" class="btn btn-default btn-sm"><i class="fas fa-plus" aria-hidden="true"></i> New File</button>
  <button id="new-dir-btn" type="button" class="btn btn-default btn-sm"><i class="fas fa-folder-plus" aria-hidden="true"></i> New Directory</button>
  <button type="button" class="btn btn-default btn-sm"><i class="fas fa-upload" aria-hidden="true"></i> Upload</button>
  <label>
    <input type="checkbox" id="show-dotfiles"> Show Dotfiles
  </label>
  <label>
    <input type="checkbox" id="show-owner-mode"> Show Owner/Mode
  </label>
</div>

<ol class="breadcrumb">
  <% @path.descend do |f| %>
  <li>
    <%= link_to f.basename, files_path(f) %>
  </li>
  <% end %>
</ol>

<div class="row">
<div class="col-md-3">
<%# FIXME: need a better solution instead of favorite links tied to an app? duplicates code in OodApp#links %>
<ul class="nav nav-pills nav-stacked well well-sm">
  <li role="presentation"><%= link_to 'Home Directory', files_path(Dir.home), style: "padding-top: 5px;padding-bottom: 5px;" %></li>
  <% OodFilesApp.new.favorite_paths.each do |p| %>
    <li><%= link_to p.title || p.path.to_s, files_path(p.path.to_s), style: "padding-top: 5px;padding-bottom: 5px;" %>
  <% end %>
</ul>
</div>

<div class="col-md-9">

<div>
  <button type="button" class="btn btn-default btn-sm"><i class="fas fa-eye" aria-hidden="true"></i> View</button>
  <button type="button" class="btn btn-default btn-sm"><i class="fas fa-edit" aria-hidden="true"></i> Edit</button>
  <button id="rename-btn" type="button" class="btn btn-default btn-sm"><i class="fas fa-font" aria-hidden="true"></i> Rename</button>
  <button type="button" class="btn btn-default btn-sm"><i class="fas fa-copy" aria-hidden="true"></i> Copy/Move</button>
  <button type="button" class="btn btn-danger pull-right btn-sm"><i class="fas fa-trash" aria-hidden="true"></i> Delete</button>
</div>

<table class="table table-striped table-condensed" id="directory-contents">
  <thead>
    <tr>
      <th>Type</th>
      <th>Name</th>
      <th>Size</th>
      <th>Modified at</th>
      <th>Owner</th>
      <th>Mode</th>
    </tr>
  </thead>
  <tbody>
  <% @files.each do |f| %>
    <tr>
      <td><%= f[:directory] ? '<span class="fa fa-folder" style="color: gold"></span>'.html_safe : '<span class="fa fa-file" style="color: lightgrey"></span>'.html_safe %></td>
      <td><%= link_to f[:name], files_path(@path.join(f[:name]).to_s) %></td>
      <td><%= f[:size] %></td>
      <td><%= f[:date] %></td>
      <td><%= f[:owner] %></td>
      <td><%= f[:mode] %></td>
    </tr>
  <% end %>
  </tbody>
</table>

</div>
</div>

<%# FIXME: problem with not using tables %>
<script>
$.fn.dataTable.ext.search.push(
    function( settings, data, dataIndex  ) {
      return $('#show-dotfiles').is(':checked') || ! data[1].startsWith('.');
    }
)

var table = $('#directory-contents').DataTable({
  paging:false,
  //FIXME: need some mixture of flexbox to control height
  scrollY: '65vh',
  scrollCollapse: true,
  select: {
    style: 'os',
    className: 'selected info',
    toggleable: false
  },
  columns: [
    null, // type
    null, // name
    null, // size
    null, // modified_at
    { visible: $('#show-owner-mode').is(':checked') }, // owner
    { visible: $('#show-owner-mode').is(':checked') } // mode
  ]
});


// is this escaped correctly?
var currentDirectory = '<%= @path %>';
var currentDirectoryUrl = '<%= files_path(@path) %>';

$('#show-dotfiles').change(() => table.draw());

// TODO: https://datatables.net/reference/button/colvis
$('#show-owner-mode').change(() => {
  let visible = $('#show-owner-mode').is(':checked');
  table.column(4).visible(visible);
  table.column(5).visible(visible);
});

// FIXME:
// upon creating new dir or new file
// should actually update view AND set file as selected

$('#new-file-btn').click(() => {
  Swal.fire({
    title: 'New File',
    input: 'text',
    inputLabel: 'Filename',
    showCancelButton: true,
    inputValidator: (value) => {
      if (! value) {
        // TODO: validate filenames against listing
        return 'Provide a filename'
      }
    }
  })
  // FIXME: do not allow / in the filename or ..
  // error cases
  .then((result) => { if(result.isConfirmed){ return Promise.resolve(result.value); }})
  .then((filename) => fetch(`${currentDirectoryUrl}/${encodeURI(filename)}`, {method: 'put'}))
  // TODO: update view with successful file creation
});

$('#new-dir-btn').click(() => {
  Swal.fire({
    title: 'New Directory',
    input: 'text',
    inputLabel: 'Directory name',
    showCancelButton: true,
    inputValidator: (value) => {
      if (! value) {
        // TODO: validate filenames against listing
        return 'Provide a directory name'
      }
    }
  })
  // FIXME: do not allow / in the filename or ..
  // error cases
  .then((result) => { if(result.isConfirmed){ return Promise.resolve(result.value); }})
  .then((filename) => fetch(`${currentDirectoryUrl}/${encodeURI(filename)}?dir=true`, {method: 'put'}))
  // TODO: update view with successful file creation
});

$('#rename-btn').click(() => {
  let selection = table.rows({selected: true}).data();
  if(selection.length != 1){
    Swal.fire('Cannot rename selection', 'Need only 1 item selected to rename', 'error')
  }
  else{
    // if there was some other attribute that just had the name...
    let filename = $($.parseHTML(selection[0][1])).text();
    console.log(filename);


    Swal.fire({
      title: 'Rename',
      input: 'text',
      inputLabel: 'Filename',
      inputValue: filename,
      showCancelButton: true,
      inputValidator: (value) => {
        if (! value) {
          // TODO: validate filenames against listing
          return 'Provide a filename to rename this to';
        }
        else if (value.includes('/') || value.includes('..')){
         return 'Filename cannot include / or ..';
        }
      }
    })
    // FIXME: do not allow / in the filename or ..
    // error cases
    .then((result) => { if(result.isConfirmed){ return Promise.resolve(result.value); }})
    .then((new_filename) => fetch('<%= files_mv_path %>', {method: 'put', body: JSON.stringify({from: `${currentDirectory}/${filename}`, to: `${currentDirectory}/${new_filename}`})}))
    // TODO: update view with successful file rename
  }
});
</script>
