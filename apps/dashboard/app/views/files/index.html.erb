<h2>files index page</h2>

<div class="text-right">
  <button id="goto-btn" type="button" class="btn btn-default btn-sm"><i class="fas fa-folder" aria-hidden="true"></i> Go To...</button>

  <%# FIXME: open in terminal should be dropdown of all clusters (with default) %>
  <button type="button" class="btn btn-default btn-sm"><i class="fas fa-terminal" aria-hidden="true"></i> Open in Terminal</button>
  <button id="new-file-btn" type="button" class="btn btn-default btn-sm"><i class="fas fa-plus" aria-hidden="true"></i> New File</button>
  <button id="new-dir-btn" type="button" class="btn btn-default btn-sm"><i class="fas fa-folder-plus" aria-hidden="true"></i> New Directory</button>
  <button id="upload-btn" type="button" class="btn btn-default btn-sm"><i class="fas fa-upload" aria-hidden="true"></i> Upload</button>
  <label>
    <input type="checkbox" id="show-dotfiles"> Show Dotfiles
  </label>
  <label>
    <input type="checkbox" id="show-owner-mode"> Show Owner/Mode
  </label>
</div>

<ol id="breadcrumbs" class="breadcrumb">
  <%= render partial: 'breadcrumb', collection: @path.descend, as: :file %>
</ol>

<div class="row">
<div class="col-md-3">
<%# FIXME: need a better solution instead of favorite links tied to an app? duplicates code in OodApp#links %>
<ul id="favorites" class="nav nav-pills nav-stacked well well-sm" style="max-height: 400px; overflow: scroll">
  <li role="presentation"><%= link_to 'Home Directory', files_path(Dir.home), style: "padding-top: 5px;padding-bottom: 5px;", class: "d" %></li>
  <% OodFilesApp.new.favorite_paths.each do |p| %>
    <li><%= link_to p.title || p.path.to_s, files_path(p.path.to_s), style: "padding-top: 5px;padding-bottom: 5px;", class: "d" %>
  <% end %>
</ul>

<div id="transfers">
  <%= render partial: 'transfers/transfer', collection: sort_by_created_at(@transfers), as: :transfer %>
</div>

<div id="clipboard">
  <!--
  <div class="well">
    <button id="clipboard-clear" type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    <p style="margin-top: 30px">Copy or move the files below to the current directory:</p>
    <ul class="list-group">
      <li class="list-group-item"><span title="directory" class="fa fa-folder" style="color: gold"></span> openhouse</li>
      <li class="list-group-item"><span title="directory" class="fa fa-file" style="color: lightgrey"></span> ts180.png</li>
    </ul>
    <button id="clipboard-copy-to-dir" class="btn btn-primary">Copy</button>  <button id="clipboard-move-to-dir" class="btn btn-danger pull-right">Move</button>
  </div>
-->
</div>


<script id="clipboard-template" type="text/template">
{{#if files}}
  <div class="well">
    <button id="clipboard-clear" type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    <p style="margin-top: 30px">Copy or move the files below from <code>{{from}}</code>to the current directory:</p>
    <ul class="list-group">
      {{#each files}}
        {{#if directory}}
          <li class="list-group-item"><span title="directory" class="fa fa-folder" style="color: gold"></span> {{name}}</li>
        {{else}}
          <li class="list-group-item"><span title="file" class="fa fa-file" style="color: lightgrey"></span> {{name}}</li>
        {{/if}}
      {{/each}}
    </ul>
    <button id="clipboard-copy-to-dir" class="btn btn-primary">Copy</button>  <button id="clipboard-move-to-dir" class="btn btn-danger pull-right">Move</button>
  </div>
{{/if}}
</script>

</div>

<div class="col-md-9">

<div>
  <button type="button" class="btn btn-default btn-sm"><i class="fas fa-eye" aria-hidden="true"></i> View</button>
  <button id="edit-btn" type="button" class="btn btn-default btn-sm"><i class="fas fa-edit" aria-hidden="true"></i> Edit</button>
  <button id="rename-btn" type="button" class="btn btn-default btn-sm"><i class="fas fa-font" aria-hidden="true"></i> Rename</button>
  <button id="download-btn" type="button" class="btn btn-primary btn-sm"><i class="fas fa-download" aria-hidden="true"></i> Download</button>
  <button id="copy-move-btn" type="button" class="btn btn-default btn-sm"><i class="fas fa-copy" aria-hidden="true"></i> Copy/Move</button>
  <button id="delete-btn" type="button" class="btn btn-danger pull-right btn-sm"><i class="fas fa-trash" aria-hidden="true"></i> Delete</button>
</div>

<table class="table table-striped table-condensed" id="directory-contents">
  <thead>
    <tr>
      <th>Type</th>
      <th>Name</th>
      <th>Size</th>
      <th>Modified at</th>
      <th>Owner</th>
      <th>Mode</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

</div>
</div>

<%# FIXME: problem with not using tables %>
<script>
history.replaceState({
  currentDirectory: '<%= @path %>',
  currentDirectoryUrl: '<%= files_path(@path) %>',
  currentDirectoryUpdatedAt: '<%= Time.now.to_i %>'
}, null);

$.fn.dataTable.ext.search.push(
    function( settings, data, dataIndex  ) {
      return $('#show-dotfiles').is(':checked') || ! data[1].startsWith('.');
    }
)

var table = $('#directory-contents').on('xhr.dt', function ( e, settings, json, xhr ) {
  // new ajax request for new data so update date/time
  if(json && json.time){
    history.replaceState(_.merge({}, history.state, {currentDirectoryUpdatedAt: json.time}), null);
  }
}).DataTable({
  ajax: {
    url: history.state.currentDirectoryUrl,
    dataSrc: 'files'
  },
  rowId: 'id',
  paging:false,
  //FIXME: need some mixture of flexbox to control height
  scrollY: '65vh',
  scrollCollapse: true,
  select: {
    style: 'os',
    className: 'selected',
    toggleable: true
  },
  columns: [
    { data: 'type', render: (data, type, row, meta) => data == 'd' ? '<span title="directory" class="fa fa-folder" style="color: gold"></span>' : '<span title="file" class="fa fa-file" style="color: lightgrey"></span>' }, // type
    { data: 'name', render: (data, type, row, meta) => `<a class="${row.type}" href="${row.url}">${Handlebars.escapeExpression(data)}</a>` }, // name
    { data: 'size' }, // size
    { data: 'modified_at' }, // modified_at
    { data: 'owner', visible: $('#show-owner-mode').is(':checked') }, // owner
    { data: 'mode', visible: $('#show-owner-mode').is(':checked') } // mode
  ]
});

function reloadTable(id){
  table.ajax.reload();

  if(id){
    table.row(id).select();
  }
}

$('#show-dotfiles').change(() => table.draw());

// TODO: https://datatables.net/reference/button/colvis
$('#show-owner-mode').change(() => {
  let visible = $('#show-owner-mode').is(':checked');
  table.column(4).visible(visible);
  table.column(5).visible(visible);
});

$('#goto-btn').click(() => {
  Swal.fire({
    title: 'Go To...',
    input: 'text',
    inputLabel: 'Path',
    inputValue: history.state.currentDirectory,
    showCancelButton: true,
    inputValidator: (value) => {
      if (! value) {
        // TODO: validate filenames against listing
        return 'Provide an absolute pathname'
      }
    },
    showClass: {
      popup: 'swal2-noanimation',
      backdrop: 'swal2-noanimation'
    },
    hideClass: {
      popup: '',
      backdrop: ''
    }
  })
  // FIXME: do not allow / in the filename or ..
  .then((result) => result.isConfirmed ? Promise.resolve(result.value) : Promise.reject('cancelled'))
  // FIXME: handle error cases

  //FIXME: relative urls too or just absolute?
  .then((pathname) => goto('https://ondemand-test.osc.edu/pun/dev/dashxdmod/files/fs/' + pathname))
  .catch(e => {
      if(e != 'cancelled'){
        //FIXME: error
        console.error(e);
      }
  })
});

$('#new-file-btn').click(() => {
  Swal.fire({
    title: 'New File',
    input: 'text',
    inputLabel: 'Filename',
    showCancelButton: true,
    inputValidator: (value) => {
      if (! value) {
        // TODO: validate filenames against listing
        return 'Provide a filename'
      }
    },
    showClass: {
      popup: 'swal2-noanimation',
      backdrop: 'swal2-noanimation'
    },
    hideClass: {
      popup: '',
      backdrop: ''
    }
  })
  // FIXME: do not allow / in the filename or ..
  .then((result) => result.isConfirmed ? Promise.resolve(result.value) : Promise.reject('cancelled'))
  // FIXME: handle error cases
  .then((filename) => fetch(`${history.state.currentDirectoryUrl}/${encodeURI(filename)}`, {method: 'put'}))
  // TODO: parse JSON response to get id of file created
  .then(() => reloadTable())
  .catch(e => {
      if(e != 'cancelled'){
        //FIXME: error
        console.error(e);
      }
  })
});

$('#new-dir-btn').click(() => {
  Swal.fire({
    title: 'New Directory',
    input: 'text',
    inputLabel: 'Directory name',
    showCancelButton: true,
    inputValidator: (value) => {
      if (! value) {
        // TODO: validate filenames against listing
        return 'Provide a directory name'
      }
    },
    showClass: {
      popup: 'swal2-noanimation',
      backdrop: 'swal2-noanimation'
    },
    hideClass: {
      popup: '',
      backdrop: ''
    }
  })
  // FIXME: do not allow / in the filename or ..
  // error cases
  .then((result) => result.isConfirmed ? Promise.resolve(result.value) : Promise.reject('cancelled'))
  .then((filename) => fetch(`${history.state.currentDirectoryUrl}/${encodeURI(filename)}?dir=true`, {method: 'put'}))
  // TODO: parse JSON response to get id of file created
  .then(() => reloadTable())
  .catch(e => {
      if(e != 'cancelled'){
        //FIXME: error
        console.error(e);
      }
  })
});

$('#rename-btn').click(() => {
  let selection = table.rows({selected: true}).data();
  if(selection.length != 1){
    Swal.fire('Cannot rename selection', 'Need only 1 item selected to rename', 'error')
  }
  else{
    // if there was some other attribute that just had the name...
    let filename = $($.parseHTML(selection[0].name)).text();

    Swal.fire({
      title: 'Rename',
      input: 'text',
      inputLabel: 'Filename',
      inputValue: filename,
      showCancelButton: true,
      inputValidator: (value) => {
        if (! value) {
          // TODO: validate filenames against listing
          return 'Provide a filename to rename this to';
        }
        else if (value.includes('/') || value.includes('..')){
         return 'Filename cannot include / or ..';
        }
      },
      showClass: {
        popup: 'swal2-noanimation',
        backdrop: 'swal2-noanimation'
      },
      hideClass: {
        popup: '',
        backdrop: ''
      }
    })
    // FIXME: do not allow / in the filename or ..
    // error cases
    .then((result) => result.isConfirmed ? Promise.resolve(result.value) : Promise.reject('cancelled'))
    .then((new_filename) => fetch('<%= files_mv_path %>', {method: 'put', body: JSON.stringify({from: `${history.state.currentDirectory}/${filename}`, to: `${history.state.currentDirectory}/${new_filename}`})}))
    //FIXME: check for request failure
    .then(() => reloadTable())
    .catch(e => {
        if(e != 'cancelled'){
          //FIXME: error
          console.error(e);
        }
    })
  }
});

// refactor then replace...

$('#download-btn').click(() => {
  let selection = table.rows({selected: true}).data();
  if(selection.length != 1){
    Swal.fire('Select only 1 file to download', 'You have selected none or multiple rows', 'error')
  }
  else if(selection[0].type == "d"){
    Swal.fire('Cannot download directory', 'Can only download files', 'error')
    // TODO
  }
  else {
    // creating the temporary iframe is exactly what the CloudCmd does
    // so this just repeats the status quo

    // FIXME: currentDirectoryUrl possible escaping issues... what if path has spaces etc.
    let filename = $($.parseHTML(selection[0].name)).text(),
        downloadUrl = `${history.state.currentDirectoryUrl}/${encodeURI(filename)}?download=${Date.now().toString()}`,
        iframe = document.createElement('iframe'),
        TIME = 30 * 1000;
    iframe.setAttribute('class', 'hidden');
    iframe.setAttribute('src', downloadUrl);

    document.body.appendChild(iframe);

    setTimeout(function() { document.body.removeChild(iframe); }, TIME);
  }
});

$('#edit-btn').click(() => {
  let selection = table.rows({selected: true}).data();
  if(selection.length != 1){
  // FIXME: modals here not great user experience
  // better to disable the button - react

    Swal.fire('Select only 1 file to edit', 'You have selected none or multiple rows', 'error')
  }
  else if(selection[0].type == "d"){
  //  Swal.fire('Cannot download directory', 'Can only download files', 'error')
  }
  else {
    window.open(selection[0].edit_url);
  }
});

//TODO: uppy locales supported - pull from server side locales
//TODO: accessibility analysis of solution

(function(){
  function closeAndResetUppyModal(uppy){
    uppy.getPlugin('Dashboard').closeModal();
    uppy.reset();
  }

  var csrf_token = document.getElementsByName('csrf-token')[0].content
  var uppy = Uppy.Core();
  uppy.use(Uppy.Dashboard, {
    trigger: '#upload-btn',
    fileManagerSelectionType: 'both',
    disableThumbnailGenerator: true,
    showLinkToFileUploadResult: false,
    closeModalOnClickOutside: true,
    closeAfterFinish: true,
    allowMultipleUploads: false,
    onRequestCloseModal: () => closeAndResetUppyModal(uppy),
  });
  uppy.use(Uppy.XHRUpload, {
    endpoint: '<%= files_upload_path %>',
    withCredentials: true,
    fieldName: 'file',
    limit: 1,
    headers: { 'X-CSRF-Token': csrf_token }
  });

  uppy.on('file-added', (file) => {
    uppy.setFileMeta(file.id, { parent: history.state.currentDirectory });
    if(file.meta.relativePath == null && file.data.webkitRelativePath){
      uppy.setFileMeta(file.id, { relativePath: file.data.webkitRelativePath });
    }
  });
})();


function goto(url, pushState = true){
  // update URL
  //FIXME: reload includes callback so if there is an error - we display it and change url back :-P
  // for example - you try to access a directory you do not have permission to access
  //
  // the only way to handle this might be to fetch the json directly, handle errors, and update the table with
  // the new JSON data - and avoid using datatables AJAX
  table.ajax.url(url);

  table.ajax.reload(function(data){
    $('#breadcrumbs').html(data.breadcrumbs_html);

    //FIXME: control coupling
    //
    // update(url, callback)
    // goto(url)
    //
    if(pushState){
      history.pushState({
        currentDirectory: data.path,
        currentDirectoryUrl: data.url
      }, data.name, data.url)
    }
  });
}

window.onpopstate = function(event){
  // FIXME: handle edge case if state ! exist
  setTimeout(() => {
    goto(event.state.currentDirectoryUrl, false);
  }, 0);
};

// borrowed from Turbolinks
// event: MouseEvent
function clickEventIsSignificant(event) {
  return !(
    // (event.target && (event.target as any).isContentEditable)
       event.defaultPrevented
    || event.which > 1
    || event.altKey
    || event.ctrlKey
    || event.metaKey
    || event.shiftKey
  )
}

$('#directory-contents tbody, #breadcrumbs, #favorites').on('click', 'a.d', function(){
  if(clickEventIsSignificant(event)){
    event.preventDefault();
    event.cancelBubble = true;
    if(event.stopPropagation) event.stopPropagation();

    goto(event.target.getAttribute("href"));
  }
});

$('#directory-contents tbody').on('dblclick', 'tr', function(){
    // handle doubleclick
    let a = this.querySelector('a');
    if(a.classList.contains('d')) goto(a.getAttribute("href"));
});

function clearClipboard(){
   localStorage.removeItem('filesClipboard');
}

function updateClipboardFromSelection(){
  let selection = table.rows({selected: true}).data();
  if(selection.length == 0){
    clearClipboard();
  }
  else {
    let clipboardData = {
      from: history.state.currentDirectory,
      files: selection.toArray().map((f) => {
          return { directory: f.type == 'd', name: f.name };
      })
    };

    localStorage.setItem('filesClipboard', JSON.stringify(clipboardData));
  }
}

function loading(title){
  Swal.fire({
    title: title,
    allowOutsideClick: false,
    showConfirmButton: false,
    willOpen: () => { Swal.showLoading()  }
  });
}

function doneLoading(){
  Swal.close();
}

var updateViewForTransfers = _.throttle(function(){
  //FIXME: error handling when this fails
  $.ajax({
    url: '<%=raw transfers_path(format: "js") %>',
    dataType: "script",
    data: {
      //TODO: verify this escapes query params
      current_directory: history.state.currentDirectory,
      current_directory_updated_at: history.state.currentDirectoryUpdatedAt
    }
  });
}, 1000);

function updateViewForClipboard(){
  let clipboard = JSON.parse(localStorage.getItem('filesClipboard') || '{}'),
      template_str  = $('#clipboard-template').html(),
      template = Handlebars.compile(template_str);

  $('#clipboard').html(template(clipboard));

  $('#clipboard-clear').click(() => {
      clearClipboard();
      updateViewForClipboard();
  });


  $('#clipboard-copy-to-dir').click(() => {
    let clipboard = JSON.parse(localStorage.getItem('filesClipboard') || 'null');

    if(clipboard){
      clipboard.to = history.state.currentDirectory;

      if(clipboard.from == clipboard.to){
        console.error('clipboard from and to are identical')

        // TODO: we want to support this use case
        // copy and paste as a new filename
        // but lots of edge cases
        // (overwrite or rename duplicates)
        // _copy
        // _copy_2
        // _copy_3
        // _copy_4
      }
      else{
        console.log('copy files to current directory:')
        console.log(clipboard);

        loading('Copying files...');

        // [{"/from/file/path":"/to/file/path" }]
        let files = {};
        clipboard.files.forEach((f) => {
          files[`${clipboard.from}/${f.name}`] = `${history.state.currentDirectory}/${f.name}`
        });

        fetch('<%= files_cp_path(format: "js") %>', {
          method: 'put',
          body: JSON.stringify({
            command: 'cp',
            files: files
          })
        })
        //TODO: if(response.status != 200){ fail!
        .then(response => response.text())
        .then((response_js) => {
          eval(response_js);
          clearClipboard();
          updateViewForClipboard();
          doneLoading();
        })
      }
    }
    else{
      console.error('files clipboard is empty');
    }
  });

  $('#clipboard-move-to-dir').click(() => {
    let clipboard = JSON.parse(localStorage.getItem('filesClipboard') || 'null');

    if(clipboard){
      clipboard.to = history.state.currentDirectory;

      if(clipboard.from == clipboard.to){
        console.error('clipboard from and to are identical')
        // TODO:
      }
      else{
        console.log('move files to current directory:')
        console.log(clipboard);

        loading('Moving files...');

        let files = {};
        clipboard.files.forEach((f) => {
          files[`${clipboard.from}/${f.name}`] = `${history.state.currentDirectory}/${f.name}`
        });

        fetch('<%= files_mv_path(format: "js") %>', {
          method: 'put',
          body: JSON.stringify({
            command: 'mv',
            files: files
          })
        })
        //TODO: if(response.status != 200){ fail!
        .then(response => response.text())
        .then((response_js) => {
          eval(response_js);
          clearClipboard();
          updateViewForClipboard();
          doneLoading();
        })
      }
    }
    else{
      console.error('files clipboard is empty');
    }
  });
}

$('#copy-move-btn').click(() => {
    updateClipboardFromSelection();
    updateViewForClipboard();
});

$('#delete-btn').click(() => {
  let files = table.rows({selected: true}).data().toArray().map((f) => f.name);
  if(! files.length > 0){
    return;
  }

  Swal.fire({
    title: 'Delete files?',
    text: 'Are you sure you want to delete the files: ' + files.join(', '),
    showCancelButton: true,
    showClass: {
      popup: 'swal2-noanimation',
      backdrop: 'swal2-noanimation'
    },
    hideClass: {
      popup: '',
      backdrop: ''
    }
  })
  .then((result) => {
    if(result.isConfirmed){
      loading('Deleting files...');

      return fetch('<%= files_rm_path(format: "js") %>', {
          method: 'delete',
          body: JSON.stringify({
            command: 'rm',
            files: files.map(f => [history.state.currentDirectory, f].join('/'))
          })
      });
    }
    else{
      return Promise.reject('cancelled');
    }
  })
  //TODO: if(response.status != 200){ fail!
  .then(response => response.text())
  .then((response_js) => {
      eval(response_js);
      doneLoading();
  })
  .catch(e => {
      if(e != 'cancelled'){
        //FIXME: error
        console.error(e);
      }

      doneLoading();
  })
});

// TODO: move all functionality out of click handlers to functions
// TODO: hide copy/move buttons if no local storage

//FIXME: so need to handle updateViewForClipboard based on EVENTS emitted by local storage modifications
updateViewForClipboard();
window.addEventListener('storage', () => {
  updateViewForClipboard();
});

// If there are running transfers, update view in 1 seconds
<%=raw 'setTimeout(() => updateViewForTransfers(), 1000);' if @transfers.any? {|t| ! t.status.completed? } %>

// if only 1 selected item, do not allow to de-select
table.on( 'user-select', function ( e, dt, type, cell, originalEvent  ) {
    var selected_rows = dt.rows( { selected: true  }  );
    if(selected_rows.count() == 1 && cell.index().row == selected_rows.indexes()[0] ){
      e.preventDefault();
    }
});
</script>
