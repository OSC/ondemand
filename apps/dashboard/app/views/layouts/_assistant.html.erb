<%# AI Assistant Widget - Inline implementation %>
<style nonce="<%= content_security_policy_nonce %>">
#ood-assistant-container {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  font-size: 14px;
  line-height: 1.5;
  z-index: 10000;
}
.ood-assistant-bubble {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 10001;
}
.ood-assistant-bubble:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}
.ood-assistant-bubble.active { transform: scale(0.9); }
.ood-assistant-bubble svg { width: 24px; height: 24px; }
.ood-assistant-chat {
  position: fixed;
  bottom: 96px;
  right: 24px;
  width: 380px;
  max-width: calc(100vw - 48px);
  height: 520px;
  max-height: calc(100vh - 140px);
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 10000;
}
.ood-assistant-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}
.ood-assistant-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}
.ood-assistant-controls { display: flex; gap: 4px; }
.ood-assistant-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  border-radius: 6px;
  padding: 6px;
  cursor: pointer;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
}
.ood-assistant-btn:hover { background: rgba(255, 255, 255, 0.3); }
.ood-assistant-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background: #f9fafb;
}
.ood-assistant-message { max-width: 85%; }
.ood-assistant-message.user { align-self: flex-end; }
.ood-assistant-message.assistant { align-self: flex-start; }
.ood-assistant-message-content {
  padding: 10px 14px;
  border-radius: 12px;
  word-wrap: break-word;
}
.ood-assistant-message.user .ood-assistant-message-content {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}
.ood-assistant-message.assistant .ood-assistant-message-content {
  background: white;
  color: #374151;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}
.ood-assistant-message.error .ood-assistant-message-content {
  background: #fef2f2;
  color: #dc2626;
}
.ood-assistant-input-container {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  padding: 12px 16px;
  background: white;
  border-top: 1px solid #e5e7eb;
}
.ood-assistant-input {
  flex: 1;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 10px 14px;
  font-size: 14px;
  resize: none;
  max-height: 120px;
  font-family: inherit;
  outline: none;
}
.ood-assistant-input:focus { border-color: #667eea; }
.ood-assistant-send {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.ood-assistant-send:disabled { opacity: 0.5; cursor: not-allowed; }
.ood-assistant-loading { padding: 8px 16px; background: #f9fafb; }
.ood-assistant-typing {
  display: flex;
  gap: 4px;
  padding: 10px 14px;
  background: white;
  border-radius: 12px;
}
.ood-assistant-typing span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #9ca3af;
  animation: typing 1.4s infinite ease-in-out;
}
.ood-assistant-typing span:nth-child(2) { animation-delay: 0.2s; }
.ood-assistant-typing span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-4px); opacity: 1; }
}
.ood-assistant-footer {
  padding: 8px 16px;
  text-align: center;
  font-size: 11px;
  color: #9ca3af;
  background: #f9fafb;
}
</style>

<div id="ood-assistant-container">
  <div id="ood-assistant-bubble" class="ood-assistant-bubble" title="AI Assistant">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
  </div>
  
  <div id="ood-assistant-chat" class="ood-assistant-chat" style="display: none;">
    <div class="ood-assistant-header">
      <div class="ood-assistant-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/>
          <path d="M12 6a4 4 0 0 0-4 4h2a2 2 0 1 1 4 0c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5a4 4 0 0 0-4-4z"/>
          <circle cx="12" cy="17" r="1"/>
        </svg>
        <span>HPC Assistant</span>
      </div>
      <div class="ood-assistant-controls">
        <button id="ood-assistant-clear" class="ood-assistant-btn" title="Clear">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
        </button>
        <button id="ood-assistant-close" class="ood-assistant-btn" title="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    </div>
    
    <div id="ood-assistant-messages" class="ood-assistant-messages">
      <div class="ood-assistant-message assistant">
        <div class="ood-assistant-message-content">
          ðŸ‘‹ Hi! I'm your HPC assistant. I can help you manage jobs, browse files, and check cluster status. What would you like to do?
        </div>
      </div>
    </div>
    
    <div id="ood-assistant-loading" class="ood-assistant-loading" style="display: none;">
      <div class="ood-assistant-typing"><span></span><span></span><span></span></div>
    </div>
    
    <div class="ood-assistant-input-container">
      <textarea id="ood-assistant-input" class="ood-assistant-input" placeholder="Ask me anything..." rows="1"></textarea>
      <button id="ood-assistant-send" class="ood-assistant-send">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
    
    <div class="ood-assistant-footer">Powered by OpenAI</div>
  </div>
</div>

<script nonce="<%= content_security_policy_nonce %>">
(function() {
  var isOpen = false;
  var history = [];
  var isLoading = false;
  
  var bubble = document.getElementById('ood-assistant-bubble');
  var chat = document.getElementById('ood-assistant-chat');
  var messages = document.getElementById('ood-assistant-messages');
  var input = document.getElementById('ood-assistant-input');
  var sendBtn = document.getElementById('ood-assistant-send');
  var loading = document.getElementById('ood-assistant-loading');
  var closeBtn = document.getElementById('ood-assistant-close');
  var clearBtn = document.getElementById('ood-assistant-clear');
  
  bubble.addEventListener('click', function() {
    isOpen = !isOpen;
    chat.style.display = isOpen ? 'flex' : 'none';
    bubble.classList.toggle('active', isOpen);
    if (isOpen) input.focus();
  });
  
  closeBtn.addEventListener('click', function() {
    isOpen = false;
    chat.style.display = 'none';
    bubble.classList.remove('active');
  });
  
  clearBtn.addEventListener('click', function() {
    history = [];
    messages.innerHTML = '<div class="ood-assistant-message assistant"><div class="ood-assistant-message-content">ðŸ‘‹ Chat cleared! How can I help?</div></div>';
  });
  
  sendBtn.addEventListener('click', sendMessage);
  
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  function sendMessage() {
    var message = input.value.trim();
    if (!message || isLoading) return;
    
    input.value = '';
    addMessage(message, 'user');
    history.push({ role: 'user', content: message });
    
    isLoading = true;
    loading.style.display = 'flex';
    sendBtn.disabled = true;
    
    fetch('/pun/sys/dashboard/assistant/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ message: message, history: history.slice(-10) })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        addMessage(data.response, 'assistant');
        history.push({ role: 'assistant', content: data.response });
      } else {
        addMessage('Error: ' + data.error, 'error');
      }
    })
    .catch(function(err) {
      addMessage('Sorry, something went wrong.', 'error');
    })
    .finally(function() {
      isLoading = false;
      loading.style.display = 'none';
      sendBtn.disabled = false;
    });
  }
  
  function addMessage(content, type) {
    var div = document.createElement('div');
    div.className = 'ood-assistant-message ' + type;
    var contentDiv = document.createElement('div');
    contentDiv.className = 'ood-assistant-message-content';
    contentDiv.innerHTML = content.replace(/\n/g, '<br>');
    div.appendChild(contentDiv);
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }
})();
</script>
