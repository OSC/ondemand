<!DOCTYPE html>
<html lang="en">

<head>
  <title>Shell</title>
  <link rel="stylesheet" href="{{baseURI}}/stylesheets/style.css">

  <script src="{{baseURI}}/javascripts/hterm_all_1.85.js"></script>
  <script src="{{baseURI}}/javascripts/ood_shell.1.js"></script>
</head>

<body>
  <div id="terminal"></div>
</body>

<script>
  var socket = null;
  setupHterm = function () {
    // Global variables that define the terminal
    var oodShell,
      terminalContainer = document.getElementById('terminal'),
      webSocketUrl      = urlWithToken(),
      terminalPrefs     = {
        'use-default-window-copy': true,
        'ctrl-v-paste': true,
        'ctrl-c-copy': true
      };
      start();


    // hterm default preferences are defined here. Switch to the tag that we're using.
    // https://chromium.googlesource.com/apps/libapps/+/master/hterm/js/hterm_preference_manager.js

    var uuid = "{{session}}";
    console.log(uuid);
    var customTerm = new CustomTerm(uuid);

    oodShell = new OodShell(terminalContainer, socket, customTerm.getTermPrefs());
    oodShell.createTerminal();

    setInterval(check, 5000);

      function start() {
    socket = new WebSocket(webSocketUrl);

    socket.onclose = function() {
      check();
    }
  }
  }

  window.onload = function() {
    lib.init(setupHterm);
  };

  var urlWithToken = function(){
    var base = document.URL.replace(/^http/, 'ws').replace(/#.*$/, '');
    var separator = '?';
    
    if(base.includes('?')){
      separator = '&';
    }

    return base + separator + "csrf={{csrfToken}}";
  }



  function check() {
    if (!socket || socket.readyState === WebSocket.CLOSED) {
      start();
    }
  }
 


</script>

</html>
